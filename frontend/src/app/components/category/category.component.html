<div class="dashboard-container">
  <nav class="dash-nav">
    <img src="logo1.png" class="auth-logo" (click)="router.navigate(['/dashboard'])" style="cursor: pointer;">
    <div class="nav-right">
      <button class="btn-nav-link" (click)="router.navigate(['/dashboard'])">Back</button>
      <button class="btn-add" (click)="openCreateModal()">+ Add Category</button>
    </div>
  </nav>

  <main class="dash-content">
    <div class="categories-grid">
      <div class="category-card" *ngFor="let cat of (groupedData$ | async)" 
           (click)="selectCategory(cat)"
           [class.active]="selectedCategory?.id === cat.id">
        
        <div class="card-header">
          <span class="icon">{{ cat.icon || 'üìÅ' }}</span>
          <div class="actions">
            <button class="btn-assign-small" (click)="openTransactionPicker(cat, $event)">+ Assign</button>
            <button class="btn-edit-small" (click)="openEditModal(cat, $event)">Edit</button>
            <button class="btn-del-small" (click)="deleteCategory(cat.id, $event)">Delete</button>
          </div>
        </div>
        
        <h3>{{ cat.name }}</h3>

        <div class="budget-container" *ngIf="cat.budgetLimit > 0">
          <div class="budget-labels">
            <span>{{ cat.totalSpent | currency:'USD' }}</span>
            <span class="limit-label">Limit: {{ cat.budgetLimit | currency:'USD' }}</span>
          </div>
          
          <div class="progress-track">
            <div class="progress-fill" 
                 [style.width.%]="cat.percent > 100 ? 100 : cat.percent"
                 [class.over-budget]="cat.percent > 100">
            </div>
          </div>

          <div class="budget-footer">
            <small [class.danger]="cat.percent > 100">{{ cat.percent | number:'1.0-0' }}% used</small>
            <small class="remaining" *ngIf="cat.budgetLimit > cat.totalSpent">
              Left: {{ (cat.budgetLimit - cat.totalSpent) | currency:'USD' }}
            </small>
          </div>
        </div>


        <p class="total-amount">Total: <span>{{ cat.total | currency:'USD' }}</span></p>
        <small class="trans-count">{{ cat.transactions?.length || 0 }} transactions</small>
      </div>
    </div>

    <div class="detail-section" *ngIf="selectedCategory">
      <div class="detail-header">
        <h2>Transactions in: {{ selectedCategory.name }}</h2>
        <button class="btn-close" (click)="selectedCategory = null"></button>
      </div>
      
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Description</th>
              <th>Date</th>
              <th>Amount</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let t of selectedCategory.transactions">
              <td>{{ t.description }}</td>
              <td>{{ t.createdAt | date:'mediumDate' }}</td>
              <td [class]="t.type === 'income' ? 'pos' : 'neg'">
                {{ t.type === 'income' ? '+' : '-' }}{{ t.amount | currency:'USD' }}
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <p class="no-data-msg" *ngIf="selectedCategory.transactions?.length === 0">No transactions in this category.</p>
    </div>
  </main>
</div>

<div class="modal-overlay" *ngIf="isCreateModalOpen">
  <div class="modal-card">
    <h3>{{ categoryToEdit ? 'Edit' : 'New' }} Category</h3>
    
    <div class="form-group">
      <label>Category Name</label>
      <input type="text" [(ngModel)]="categoryForm.name" placeholder="e.g. Food" class="dark-input">
    </div>

    <div class="form-group">
      <label>Icon (Emoji)</label>
      <input type="text" [(ngModel)]="categoryForm.icon" placeholder="üçî" class="dark-input">
    </div>

    <div class="modal-actions">
      <button class="btn-cancel" (click)="isCreateModalOpen = false">Cancel</button>
      <button class="btn-save" (click)="saveCategory()">
        {{ categoryToEdit ? 'Save Changes' : 'Create' }}
      </button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="categoryToDeleteId">
  <div class="modal-card delete-confirm">
    <h3>Are you sure?</h3>
    <p>Do you really want to delete this transaction? This action cannot be undone.</p>
    
    <div class="modal-actions">
      <button class="btn-cancel" (click)="categoryToDeleteId = null">Cancel</button>
      <button class="btn-save btn-danger" (click)="deleteCategory()">Delete Now</button>
    </div>
  </div>
</div>


<app-transaction-picker 
  *ngIf="isTransactionPickerOpen"
  [transactions]="(allTransactions$ | async) || []"
  [categoryName]="targetCategory?.name"
  (onAssign)="onTransactionsSelected($event)" 
  (onCancel)="isTransactionPickerOpen = false">
</app-transaction-picker>